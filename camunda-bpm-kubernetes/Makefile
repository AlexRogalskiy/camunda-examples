# @afirth 2019-05

# Make config
.SHELLFLAGS := -eu -o pipefail -c
MAKEFLAGS += --warn-undefined-variables
SHELL = /bin/bash
.SUFFIXES:

mfst := ./generated-manifest.yaml

.PHONY: all
all: deps manifests apply

.PHONY: apply
apply:
	kubectl apply -f $(mfst)

.PHONY: manifests
manifests:
	echo "## Generated by Kustomize @"`git describe --always --abbrev=0 --match "NOT A TAG" --dirty="-DIRTY"` > $(mfst)
	kustomize build >> $(mfst)

.PHONY: dry-run
dry-run: deps manifests
	kubectl apply -o yaml --dry-run -f $(mfst)

.PHONY: skaffold
skaffold: dev-deps manifests
	skaffold run

.PHONY: deps
deps:
	@which kustomize 1>/dev/null || echo kustomize not found. Try go get sigs.k8s.io/kustomize

.PHONY: dev-deps
dev-deps: deps
	@which skaffold 1>/dev/null || echo skaffold not found. Try https://skaffold.dev/docs/getting-started/#installing-skaffold

